<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="robots" content="none,noindex,nofollow">
    <meta name="description" content="ハンドメイドショップサイト">
    <meta name="keywords" content="ECサイト">
    <title>U labeler</title>

    <link href="/stylesheets/top.css" rel="stylesheet" type="text/css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>

</head>
<header class="header">

    <div class="header_logo">
        <h1><a href="/"><img src="/images/system/logo.png" alt="Ulabeler"></a></h1>
    </div>

    <!-- 検索ボックス -->
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <span class="magnifying_glass"></span>
    <form method="get" action="#" class="search_container">
        <input type="text" size="25" placeholder="キーワード検索">
        <input type="submit" value="&#xf002">
    </form>

    <body>

        <input type="checkbox" id="nav1">
        <label for="nav1" class="open"><span></span></label>
        <label for="nav1" class="close"></label>

        <%- include("../components/sidemenu.ejs", {side_menu: side_menu}) %>

            <article>
                <br>
                <br>

                <!-- ページ名 -->
                <h3 class="h3_center2">作品詳細設定
                    <hr>
                </h3>

                <section class="box_item_4">
                    <br>
                    <div class="userpage">
                        <div class="user_3">
                            <form action="" method="post" id="hoge">
                                <div class="user_box_1">
                                    <a href="">
                                        <table cellpadding="0" 　class="usertable">

                                            <tr>
                                                <th rowspan="4">
                                                    <p class=user_img2><img src="<%- userInfo.icon_path %>"
                                                            alt="ユーザーアイコン"></p>
                                                </th>
                                                <td>　　　　　</td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <p class="username">
                                                        <%- userInfo.name %>
                                                    </p>
                                                </td>
                                                <input type="hidden" name="">

                                            </tr>
                                            <tr>
                                                <td class="userid2">＠<%- userInfo.id %>
                                                </td>
                                                <input type="hidden" name="">
                                            </tr>


                                        </table>
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class=userpage>
                    </div>
                    <p class="date1">
                        <%# work.create_atをyyyy/mm/ddで表示する %>
                            <% const create_at=new Date(work.create_at)%>
                                <%= create_at.getFullYear() + "/" + ('00' + (create_at.getMonth()+1)).slice(-2) + "/" +
                                    ('00' + create_at.getDate()).slice(-2) %>
                    </p>
                    <div class="image_wrapper"><img src="<%= work.thumbnail_path %>" alt="<%- work.name %>" /></div>
                    <form action="#" method="post">
                        <p class="explanation">
                            <%- baseCategory.name_subcategory %>
                        </p>

                        <br>
                        <table class="setumeitable3" 　　>
                            <tr>
                                <th>作品名　　<font color="red">*</font>：</th>
                                <th><input type=”text” class="tekisuto" style=" height: 30px; width: 400px;" name=”name”
                                        placeholder="20文字以内" value="<%- work.name %>" id="workName"></p>
                                </th>

                            </tr>
                            <tr>
                                <th></th>
                                <th class="gyoukann">
                                    <p class="error_message7" id="errorWorkName"></p>
                                </th>
                            </tr>

                            <tr>
                                <th>作品説明文<font color="red">*</font>：</th>
                                <th>
                                    <font color="#85858"><textarea class="tekisuto" placeholder="150文字以内"
                                            name="example2" cols="55" rows="8" wrap="soft"
                                            id="workIntroduction"><%- work.introduction %></textarea></font>
                                    </p>
                                </th>
                            </tr>
                            <tr>
                                <th></th>
                                <th class="gyoukann">
                                    <p class="error_message7" id="errorWorkIntroduction"></p>
                                </th>
                            </tr>

                        </table>
                        <div class="check">
                            <input id="isPublic" type="checkbox" class="check1" name="check"
                                <%if(work.flag_public){%>checked<%}%>>公開
                        </div>
                        <div class="double_button4">
                            <table class="button_table">
                                <tr>
                                    <th style="width: 20%;"></th>
                                    <th><button type="button" class="white_button2"
                                            onclick="history.back()">戻る</button></th>
                                    <th style="width: 30%;"></th>
                                    <th><button type="button" class="black_button2" id="send"
                                            onclick="update()">決定</button>
                                    </th>
                                    <th style="width: 20%;"></th>
                                </tr>
                            </table>
                            <br>

                        </div>
                    </form>
                </section>

                </div>

                </div>

                <noscript>
                    <p>JavaScriptを有効にしてください。</p>
                </noscript>
            </article>
            <br>
            <br>
            <p><a href="#"><span class="iro3">Copyright&copy; U labeler</span></p></a>
            <br>
            <a href="#" id="pagetop"><i class="up"></i>↑</a>
    </body>

    <script>
        const workName = document.getElementById('workName');
        const workIntroduction = document.getElementById('workIntroduction');
        const isPublic = document.getElementById('isPublic');
        const send = document.getElementById('send');

        const errorWorkName = document.getElementById('errorWorkName');
        const errorWorkIntroduction = document.getElementById('errorWorkIntroduction');

        let errorCountWorkName = 0;
        let errorCountWorkIntroduction = 0;
        let tooMany = false;

        workName.addEventListener("keyup",()=>{
            if(workName.value.length > 20){
                errorWorkName.innerHTML = "20文字以内で入力してください";
                errorCountWorkName++;
            }else if(workName.value.length == 0){
                errorWorkName.innerHTML = "この項目は必須です。";
                errorCountWorkName++;
            }else{
                errorWorkName.innerHTML = "";
                errorCountWorkName = 0;
            }
        });

        workIntroduction.addEventListener("keyup",()=>{
            if(workIntroduction.value.length > 150){
                tooMany = true;
                errorWorkIntroduction.innerHTML = "150文字以内で入力してください";
                errorCountWorkIntroduction++;
            }else if(workIntroduction.value.length == 0){
                errorWorkIntroduction.innerHTML =  "20文字以内で入力してください";
                errorCountWorkIntroduction++;
            }else{
                errorWorkIntroduction.innerHTML = "";
                errorCountWorkIntroduction = 0;
            }
        });

        workName.addEventListener("focusout", ()=>{
            if (workName.value.length > 0) {
                // @ts-ignore
                axios.post('https://tools.na2na.dev/api/word/is_includeNgWord', {
                    text: workName.value,
                })
                    .then(function (response) {
                        if (response.data == true) {
                            errorWorkName.innerText = '不適切なワードが含まれています。';
                            errorCountWorkName++;
                        } else {
                            if (tooMany) {
                                return;
                            }else{
                                errorWorkName.innerText = '';
                            if (workName.value.length == 0) {
                                errorCountWorkName++;
                            } else {
                                errorCountWorkName = 0;
                            }
                        }
                        }
                    })
                    .catch(function (error) {
                        alert(error); // TODO: エラー時の遷移先
                    });
            }
        });

        workIntroduction.addEventListener("focusout", ()=>{
            if (workIntroduction.value.length > 0) {
                // @ts-ignore
                axios.post('https://tools.na2na.dev/api/word/is_includeNgWord', {
                    text: workIntroduction.value,
                })
                    .then(function (response) {
                        if (response.data == true) {
                            errorWorkIntroduction.innerText = '不適切なワードが含まれています。';
                            errorCountWorkIntroduction++;
                        } else {
                            if (tooMany) {
                                return;
                            }else{
                                errorWorkIntroduction.innerText = '';
                            if (workIntroduction.value.length == 0) {
                                errorCountWorkIntroduction++;
                            } else {
                                errorCountWorkIntroduction = 0;
                            }
                        }
                        }
                    })
                    .catch(function (error) {
                        alert(error); // TODO: エラー時の遷移先
                    });
            }
        });

        //0.2秒ごとに監視して、errorCountWorkIntroductionとerrorCountWorkNameが0以上なら送信ボタンを無効化する
        setInterval(()=>{
            if(errorCountWorkName >= 1 || errorCountWorkIntroduction >= 1){
                send.disabled = true;
            }else{
                send.disabled = false;
            }
        },200);

        function update() {
            console.log(workName.value);
            console.log(workIntroduction.value);
            console.log(isPublic.checked);
            // 文字が入力されているかを確認
            if (workName.value.length == 0) {
                errorWorkName.innerHTML = "この項目は必須です。";
                errorCountWorkName++;
                return
            }
            if (workIntroduction.value.length == 0) {
                errorWorkIntroduction.innerHTML = "この項目は必須です。";
                errorCountWorkIntroduction++;
                return
            }
            // @ts-ignore
            
        }
    </script>

</html>