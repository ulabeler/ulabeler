<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta name="robots" content="none,noindex,nofollow">
  <meta name="description" content="ハンドメイドショップサイト">
  <meta name="keywords" content="ECサイト">
  <title>U labeler</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
  <link href="/stylesheets/top.css" rel="stylesheet" type="text/css">
  </link>

</head>
<header class="header">

  <div class="header_logo">
    <h1><a href="/"><img src="/images/system/logo.png" alt="Ulabeler"></a></h1>
  </div>

  <!-- 検索ボックス -->
  <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <span class="magnifying_glass"></span>
  <form method="get" action="#" class="search_container">
    <input type="text" size="25" placeholder="キーワード検索">
    <input type="submit" value="&#xf002">
  </form>

  </div>


  <body>

    <!-- <input type="checkbox" id="nav1">
    <label for="nav1" class="open"><span></span></label>
    <label for="nav1" class="close"></label> -->


        <article>

          <div class="box09">

            <!-- 入力フォーム -->
            <form action="" method="post" id="hoge">
              <div class="login_input">
                <div class="input_center">
                  <p>仮のパスワード<font color="red">*</font>　　　　　　　:　<input type="text" name="temp_password" size="35"></p>
                </div>
                <div class="password_update_error">
                  <p id="error_temp_password" class="error_message3"></p>
                  <!-- やま jsエラーメッセージ -->
                </div>
                <div class="input_center">
                  <p>新しいパスワード<font color="red">*</font>　　　　　　:　<input type="password" name="new_password" size="35"
                      placeholder="半角英数字8文字以上15文字以内"></p>
                </div>
                <div class="input_center">
                  <p>新しいパスワード（確認用）<font color="red">*</font>　:　<input type="password" name="new_password_confirmation"
                      size="35" placeholder="半角英数字8文字以上15文字以内"></p>
                </div>
                <div class="password_update_error">
                  <p id="error_password" class="error_message3"></p><!-- やま jsエラーメッセージ -->
                </div>
              </div>

            </form>

            <div class="double_button">
              <button type="submit" class="white_button" onclick="location.href='top.html'">戻る</button>
              <button type="submit" class="black_button" onclick="resetPasswordAttempt()" id="send">決定</button>
            </div>


          </div>

          <noscript>
            <p>JavaScriptを有効にしてください。</p>
          </noscript>

        </article>
        <br>
        <p><a href="/"><span class="iro3">Copyright&copy; U labeler</span></p></a>
        <br>
  </body>

  <script>
    //TODO: トークンがおかしい時の遷移/ルーター側
    //変数定義
    const url = new URL(window.location.href);
    const id = url.searchParams.get("id");
    const token = url.searchParams.get("token");
    const temp_password = document.querySelector('input[name="temp_password"]');
    const new_password = document.querySelector('input[name="new_password"]');
    const new_password_confirmation = document.querySelector('input[name="new_password_confirmation"]');
    const error_temp_password = document.getElementById('error_temp_password');
    const error_password = document.getElementById('error_password');
    const send = document.getElementById('send');

    let disable_counter_password = 0;
    let confirm_reject_counter_password = 0;

    new_password.addEventListener('keyup', function () {
      if (new_password.value.length < 8) {
        error_password.innerText = '8文字以上で入力してください';
        disable_counter_password++;
      } else if (new_password.value.length > 20) {
        error_password.innerText = '20文字以内で入力してください';
        disable_counter_password++;
      } else if (new_password.value.match(/[^a-zA-Z0-9_\-\.]/)) {
        error_password.innerText = '使用できる文字は、半角英数字、アンダーバー、ハイフン、ピリオドのみです';
        disable_counter_password++;
      } else if (!new_password.value.match(/[a-z]/)) {
        error_password.innerText = '大文字小文字を最低41つ以上含めてください';
        disable_counter_password++;
      } else if (!new_password.value.match(/[A-Z]/)) {
        error_password.innerText = '大文字小文字を最低1つ以上含めてください';
        disable_counter_password++;
      } else {
        error_password.innerText = '';
        if (new_password.value.length == 0) {
          disable_counter_password++;
        } else {
          disable_counter_password = 0;
        }
      }
    });

    setInterval(function () {
      if (disable_counter_password === 0) {
        send.disabled = false;
      } else {
        send.disabled = true;
      }
      if (confirm_reject_counter_password > 0) {
        check_password_confirm();
      }
    }, 100);

    function check_password_confirm() {
      if (new_password.value !== new_password_confirmation.value) {
        error_password.innerText = 'パスワードが一致しません';
        confirm_reject_counter_password++;
        return false;
      } else {
        error_password.innerText = '';
        disable_counter_password_confirm = 0;
          disable_counter_password = 0;
        return true;
      }
    }

    function resetPasswordAttempt() {
      console.log(id);
      console.log(token);
      console.log(temp_password.value);
      console.log(new_password.value);
      console.log(new_password_confirmation.value);

      check_password_confirm()

      axios.post('/api/user/create/temp_password', {
        id: id,
        token: token,
        temp_password: temp_password.value,
        new_password: new_password_confirmation.value
      })
        .then(function (response) {
          console.log(response);
          //200と、trueが帰ったら
          if (response.status == 201) {
            alert('パスワードを変更しました。');
            location.href = '/';
            //401かつ、回答がTemp Password is wrong
          } else if (response.status == 200 && response.data == 'Temp Password is wrong') {
            console.log(response.status);
            error_temp_password.innerText = '仮のパスワードが違います。';
          }
        })
        .catch(function (error) {
          console.log(error);
        });
    }
  </script>

</html>